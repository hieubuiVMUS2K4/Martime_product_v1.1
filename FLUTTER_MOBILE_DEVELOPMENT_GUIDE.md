# üì± FLUTTER MOBILE APP - H∆Ø·ªöNG D·∫™N PH√ÅT TRI·ªÇN CHO THUY·ªÄN VI√äN

## üéØ T·ªïng Quan H·ªá Th·ªëng

### Ki·∫øn Tr√∫c Mobile App
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FLUTTER MOBILE APP                        ‚îÇ
‚îÇ              (Ch·∫°y tr√™n ƒëi·ªán tho·∫°i thuy·ªÅn vi√™n)             ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  [Login] ‚Üí [Profile] ‚Üí [My Tasks] ‚Üí [Schedule] ‚Üí [Reports]  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  ‚Ä¢ Kh√¥ng c√≥ Database local                                   ‚îÇ
‚îÇ  ‚Ä¢ Cache data (SharedPreferences/Hive)                      ‚îÇ
‚îÇ  ‚Ä¢ K·∫øt n·ªëi LAN v·ªõi Edge Server                              ‚îÇ
‚îÇ  ‚Ä¢ Offline-first v·ªõi sync queue                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚îÇ HTTP/REST API
                    ‚îÇ LAN: 192.168.1.x:5001
                    ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ   EDGE SERVER API     ‚îÇ
        ‚îÇ   (Tr√™n t√†u)          ‚îÇ
        ‚îÇ   Port 5001           ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  PostgreSQL Database  ‚îÇ
        ‚îÇ  (Tr√™n t√†u)           ‚îÇ
        ‚îÇ  Port 5433            ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÇ C·∫§U TR√öC D·ª∞ √ÅN FLUTTER

### Th∆∞ M·ª•c G·ªëc
```
frontend-mobile/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ main.dart                      # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ app.dart                       # MaterialApp config
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ core/                          # Core functionality
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ constants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api_constants.dart     # API endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app_constants.dart     # App configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cache_keys.dart        # Cache keys
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ network/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api_client.dart        # HTTP client
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api_interceptor.dart   # Request/response interceptor
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network_info.dart      # Check connectivity
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cache_manager.dart     # Cache operations
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sync_queue.dart        # Offline sync queue
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_manager.dart      # Authentication
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ token_storage.dart     # JWT token storage
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ date_formatter.dart
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ validators.dart
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ error_handler.dart
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ data/                          # Data layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crew_member.dart       # Crew model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ maintenance_task.dart  # Task model
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schedule.dart          # Schedule model
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sync_item.dart         # Sync queue item
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crew_repository.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task_repository.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ sync_repository.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data_sources/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ remote/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ crew_api.dart
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ task_api.dart
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ auth_api.dart
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ local/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ cache_data_source.dart
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ domain/                        # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crew.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ task.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ usecases/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ login_usecase.dart
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ get_my_tasks_usecase.dart
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ complete_task_usecase.dart
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sync_data_usecase.dart
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ presentation/                  # UI layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ splash/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ splash_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ forgot_password_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ home_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ certificates_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task_list_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task_detail_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ complete_task_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schedule/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schedule_screen.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ settings_screen.dart
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ server_config_screen.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ widgets/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ loading_widget.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ error_widget.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ empty_state_widget.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ task_card.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ priority_badge.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ certificate/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ certificate_status_card.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ auth_provider.dart
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ task_provider.dart
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ sync_provider.dart
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ routes/
‚îÇ       ‚îî‚îÄ‚îÄ app_router.dart            # Navigation routes
‚îÇ
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logo.png
‚îÇ   ‚îî‚îÄ‚îÄ icons/
‚îÇ
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ widget/
‚îÇ   ‚îî‚îÄ‚îÄ integration/
‚îÇ
‚îú‚îÄ‚îÄ pubspec.yaml                       # Dependencies
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ analysis_options.yaml              # Linting rules
```

---

## üì¶ DEPENDENCIES (pubspec.yaml)

```yaml
name: maritime_crew_app
description: Mobile app for ship crew members to manage tasks and schedules
version: 1.0.0+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter

  # State Management
  provider: ^6.1.1                    # Simple state management
  flutter_riverpod: ^2.4.9           # Alternative: Riverpod

  # Network & API
  dio: ^5.4.0                         # HTTP client
  connectivity_plus: ^5.0.2           # Network connectivity
  retrofit: ^4.0.3                    # Type-safe REST client
  pretty_dio_logger: ^1.3.1           # API logging

  # Local Storage & Cache
  shared_preferences: ^2.2.2          # Simple key-value storage
  hive: ^2.2.3                        # Fast NoSQL database
  hive_flutter: ^1.1.0
  path_provider: ^2.1.1               # File system paths

  # Authentication & Security
  flutter_secure_storage: ^9.0.0     # Secure storage for tokens
  jwt_decoder: ^2.0.1                 # JWT parsing

  # UI Components
  cupertino_icons: ^1.0.6
  google_fonts: ^6.1.0                # Custom fonts
  flutter_svg: ^2.0.9                 # SVG support
  cached_network_image: ^3.3.0        # Image caching
  shimmer: ^3.0.0                     # Loading skeleton
  lottie: ^2.7.0                      # Animations

  # Date & Time
  intl: ^0.18.1                       # Internationalization
  timeago: ^3.6.0                     # Relative time

  # Forms & Validation
  flutter_form_builder: ^9.1.1
  form_builder_validators: ^9.1.0

  # QR Code Scanner (Optional - for equipment scanning)
  qr_code_scanner: ^1.0.1
  mobile_scanner: ^3.5.5

  # Utils
  get_it: ^7.6.4                      # Dependency injection
  logger: ^2.0.2                      # Logging
  uuid: ^4.2.2                        # UUID generation
  equatable: ^2.0.5                   # Value equality

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.1
  build_runner: ^2.4.7
  hive_generator: ^2.0.1
  retrofit_generator: ^8.0.4
  mockito: ^5.4.4                     # Testing

flutter:
  uses-material-design: true
  assets:
    - assets/images/
    - assets/icons/
```

---

## üîß C√ÅC FILE CH√çNH C·∫¶N T·∫†O

### 1. **API Constants** (`lib/core/constants/api_constants.dart`)

```dart
class ApiConstants {
  // Base URL - C√≥ th·ªÉ thay ƒë·ªïi trong Settings
  static String baseUrl = 'http://192.168.1.100:5001'; // LAN IP c·ªßa Edge Server
  
  // Auth Endpoints
  static const String login = '/api/auth/login';
  static const String logout = '/api/auth/logout';
  static const String refreshToken = '/api/auth/refresh';
  
  // Crew Endpoints
  static const String crewProfile = '/api/crew/me';
  static const String crewCertificates = '/api/crew/me/certificates';
  
  // Maintenance Task Endpoints
  static const String myTasks = '/api/maintenance/tasks/my-tasks';
  static const String taskDetail = '/api/maintenance/tasks/{id}';
  static const String completeTask = '/api/maintenance/tasks/{id}/complete';
  static const String startTask = '/api/maintenance/tasks/{id}/start';
  
  // Schedule Endpoints
  static const String mySchedule = '/api/schedule/my-schedule';
  static const String upcomingTasks = '/api/schedule/upcoming';
  
  // Sync Endpoints
  static const String syncStatus = '/api/sync/status';
  static const String syncData = '/api/sync/upload';
  
  // Timeouts
  static const int connectionTimeout = 30000; // 30 seconds
  static const int receiveTimeout = 30000;
  
  // Cache Duration
  static const Duration cacheDuration = Duration(hours: 1);
}
```

### 2. **API Client** (`lib/core/network/api_client.dart`)

```dart
import 'package:dio/dio.dart';
import 'package:pretty_dio_logger/pretty_dio_logger.dart';
import '../constants/api_constants.dart';
import 'api_interceptor.dart';

class ApiClient {
  late Dio _dio;
  
  ApiClient() {
    _dio = Dio(
      BaseOptions(
        baseUrl: ApiConstants.baseUrl,
        connectTimeout: Duration(milliseconds: ApiConstants.connectionTimeout),
        receiveTimeout: Duration(milliseconds: ApiConstants.receiveTimeout),
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
      ),
    );
    
    // Add interceptors
    _dio.interceptors.addAll([
      ApiInterceptor(), // Custom interceptor for auth
      PrettyDioLogger(
        requestHeader: true,
        requestBody: true,
        responseBody: true,
        responseHeader: false,
        error: true,
        compact: true,
      ),
    ]);
  }
  
  Dio get dio => _dio;
  
  // Update base URL (when user changes server settings)
  void updateBaseUrl(String newBaseUrl) {
    _dio.options.baseUrl = newBaseUrl;
    ApiConstants.baseUrl = newBaseUrl;
  }
}
```

### 3. **Auth Interceptor** (`lib/core/network/api_interceptor.dart`)

```dart
import 'package:dio/dio.dart';
import '../auth/token_storage.dart';

class ApiInterceptor extends Interceptor {
  final TokenStorage _tokenStorage = TokenStorage();
  
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) async {
    // Add JWT token to header if exists
    final token = await _tokenStorage.getAccessToken();
    if (token != null) {
      options.headers['Authorization'] = 'Bearer $token';
    }
    
    super.onRequest(options, handler);
  }
  
  @override
  void onError(DioException err, ErrorErrorInterceptorHandler handler) async {
    // Handle 401 Unauthorized - Refresh token or logout
    if (err.response?.statusCode == 401) {
      // Try to refresh token
      final refreshed = await _refreshToken();
      if (refreshed) {
        // Retry the request
        final opts = err.requestOptions;
        final token = await _tokenStorage.getAccessToken();
        opts.headers['Authorization'] = 'Bearer $token';
        
        try {
          final response = await Dio().fetch(opts);
          return handler.resolve(response);
        } catch (e) {
          return handler.reject(err);
        }
      } else {
        // Logout user
        await _tokenStorage.clearTokens();
        // Navigate to login screen
      }
    }
    
    super.onError(err, handler);
  }
  
  Future<bool> _refreshToken() async {
    // Implement token refresh logic
    return false;
  }
}
```

### 4. **Token Storage** (`lib/core/auth/token_storage.dart`)

```dart
import 'package:flutter_secure_storage/flutter_secure_storage.dart';

class TokenStorage {
  final FlutterSecureStorage _storage = const FlutterSecureStorage();
  
  static const String _accessTokenKey = 'access_token';
  static const String _refreshTokenKey = 'refresh_token';
  static const String _userIdKey = 'user_id';
  static const String _crewIdKey = 'crew_id';
  
  // Save tokens after login
  Future<void> saveTokens({
    required String accessToken,
    required String refreshToken,
    required int userId,
    required String crewId,
  }) async {
    await Future.wait([
      _storage.write(key: _accessTokenKey, value: accessToken),
      _storage.write(key: _refreshTokenKey, value: refreshToken),
      _storage.write(key: _userIdKey, value: userId.toString()),
      _storage.write(key: _crewIdKey, value: crewId),
    ]);
  }
  
  Future<String?> getAccessToken() async {
    return await _storage.read(key: _accessTokenKey);
  }
  
  Future<String?> getRefreshToken() async {
    return await _storage.read(key: _refreshTokenKey);
  }
  
  Future<String?> getCrewId() async {
    return await _storage.read(key: _crewIdKey);
  }
  
  Future<void> clearTokens() async {
    await _storage.deleteAll();
  }
}
```

### 5. **Cache Manager** (`lib/core/cache/cache_manager.dart`)

```dart
import 'package:hive/hive.dart';
import 'dart:convert';

class CacheManager {
  static const String _cacheBox = 'cache_box';
  
  Future<void> init() async {
    await Hive.openBox(_cacheBox);
  }
  
  // Save data to cache
  Future<void> saveData(String key, dynamic data) async {
    final box = Hive.box(_cacheBox);
    await box.put(key, jsonEncode({
      'data': data,
      'timestamp': DateTime.now().millisecondsSinceEpoch,
    }));
  }
  
  // Get cached data
  Future<dynamic> getData(String key) async {
    final box = Hive.box(_cacheBox);
    final cached = box.get(key);
    
    if (cached == null) return null;
    
    final decoded = jsonDecode(cached);
    final timestamp = decoded['timestamp'] as int;
    final now = DateTime.now().millisecondsSinceEpoch;
    
    // Check if cache is expired (1 hour)
    if (now - timestamp > 3600000) {
      await box.delete(key);
      return null;
    }
    
    return decoded['data'];
  }
  
  // Clear all cache
  Future<void> clearCache() async {
    final box = Hive.box(_cacheBox);
    await box.clear();
  }
}
```

### 6. **Sync Queue** (`lib/core/cache/sync_queue.dart`)

```dart
import 'package:hive/hive.dart';
import '../network/network_info.dart';
import '../../data/models/sync_item.dart';

class SyncQueue {
  static const String _syncBox = 'sync_queue';
  final NetworkInfo _networkInfo;
  
  SyncQueue(this._networkInfo);
  
  // Add item to sync queue (when offline)
  Future<void> addToQueue(SyncItem item) async {
    final box = await Hive.openBox<SyncItem>(_syncBox);
    await box.add(item);
  }
  
  // Get all pending items
  Future<List<SyncItem>> getPendingItems() async {
    final box = await Hive.openBox<SyncItem>(_syncBox);
    return box.values.toList();
  }
  
  // Process sync queue when online
  Future<void> processSyncQueue() async {
    if (!await _networkInfo.isConnected) {
      return;
    }
    
    final box = await Hive.openBox<SyncItem>(_syncBox);
    final items = box.values.toList();
    
    for (var item in items) {
      try {
        // Send to server based on item type
        await _syncItemToServer(item);
        
        // Remove from queue after successful sync
        final key = box.keys.firstWhere((k) => box.get(k) == item);
        await box.delete(key);
      } catch (e) {
        // Keep in queue if sync fails
        print('Sync failed for item ${item.id}: $e');
      }
    }
  }
  
  Future<void> _syncItemToServer(SyncItem item) async {
    // Implement sync logic based on item type
    switch (item.type) {
      case SyncItemType.taskComplete:
        // Call complete task API
        break;
      case SyncItemType.taskStart:
        // Call start task API
        break;
      // Add more cases
    }
  }
  
  // Get queue size
  Future<int> getQueueSize() async {
    final box = await Hive.openBox<SyncItem>(_syncBox);
    return box.length;
  }
}
```

### 7. **Network Info** (`lib/core/network/network_info.dart`)

```dart
import 'package:connectivity_plus/connectivity_plus.dart';

class NetworkInfo {
  final Connectivity _connectivity = Connectivity();
  
  Future<bool> get isConnected async {
    final result = await _connectivity.checkConnectivity();
    return result != ConnectivityResult.none;
  }
  
  Stream<ConnectivityResult> get onConnectivityChanged {
    return _connectivity.onConnectivityChanged;
  }
}
```

---

## üé® C√ÅC SCREEN CH√çNH

### 1. **Login Screen** (`lib/presentation/screens/auth/login_screen.dart`)

**Ch·ª©c nƒÉng:**
- Input: Crew ID + Password
- L∆∞u token v√†o secure storage
- Cache th√¥ng tin user
- Ki·ªÉm tra k·∫øt n·ªëi LAN v·ªõi Edge Server

**UI Elements:**
- Logo Maritime
- TextField: Crew ID (VD: CM001)
- TextField: Password
- Button: Login
- Link: Forgot Password / Settings (Server Config)

### 2. **Home Screen** (`lib/presentation/screens/home/home_screen.dart`)

**Ch·ª©c nƒÉng:**
- Dashboard t·ªïng quan
- Quick stats: Tasks pending, overdue, completed today
- Recent activities
- Navigation to other screens

**UI Elements:**
- AppBar v·ªõi avatar + t√™n crew
- Stats cards
- Quick action buttons
- Bottom Navigation Bar: Home, Tasks, Schedule, Profile

### 3. **Profile Screen** (`lib/presentation/screens/profile/profile_screen.dart`)

**Ch·ª©c nƒÉng:**
- Hi·ªÉn th·ªã th√¥ng tin c√° nh√¢n
- Xem certificates (STCW, Medical, Passport)
- Status badges (Valid, Expiring Soon, Expired)

**UI Elements:**
- Avatar + Crew info
- Personal details (readonly)
- Certificate status cards v·ªõi m√†u s·∫Øc
- Navigation to Certificate details

### 4. **Task List Screen** (`lib/presentation/screens/tasks/task_list_screen.dart`)

**Ch·ª©c nƒÉng:**
- Hi·ªÉn th·ªã tasks ƒë∆∞·ª£c assigned cho crew hi·ªán t·∫°i
- Filter: All, Pending, In Progress, Overdue
- Pull to refresh
- Search by equipment name

**UI Elements:**
- Tabs: All | Pending | Overdue
- Task cards v·ªõi priority badges
- Countdown timer (days until due)
- Click v√†o task ‚Üí Task Detail

### 5. **Task Detail Screen** (`lib/presentation/screens/tasks/task_detail_screen.dart`)

**Ch·ª©c nƒÉng:**
- Xem chi ti·∫øt maintenance task
- Start task (n·∫øu pending)
- Complete task (n·∫øu in progress)
- View equipment info
- View history

**UI Elements:**
- Equipment name + Task ID
- Priority & Status badges
- Due date v·ªõi countdown
- Task description
- Interval info
- Last done info
- Action buttons: Start / Complete
- Notes section

### 6. **Complete Task Screen** (`lib/presentation/screens/tasks/complete_task_screen.dart`)

**Ch·ª©c nƒÉng:**
- Form nh·∫≠p th√¥ng tin ho√†n th√†nh task
- Offline support: L∆∞u v√†o sync queue n·∫øu m·∫•t m·∫°ng
- Validation form

**UI Elements:**
- Form fields:
  - Running Hours (number)
  - Spare Parts Used (text)
  - Completion Notes (textarea)
  - Photo upload (optional)
- Button: Complete Task
- Offline indicator

### 7. **Schedule Screen** (`lib/presentation/screens/schedule/schedule_screen.dart`)

**Ch·ª©c nƒÉng:**
- Calendar view c·ªßa tasks
- Xem tasks theo timeline
- Filter by week/month

**UI Elements:**
- Calendar v·ªõi dots tr√™n ng√†y c√≥ task
- List tasks c·ªßa ng√†y ƒë∆∞·ª£c ch·ªçn
- Timeline view
- Legend: Priority colors

### 8. **Settings Screen** (`lib/presentation/screens/settings/settings_screen.dart`)

**Ch·ª©c nƒÉng:**
- Server configuration (Change LAN IP)
- Clear cache
- View sync queue status
- Logout

**UI Elements:**
- Server IP input
- Test connection button
- Cache size display
- Sync queue count
- Clear cache button
- Logout button

---

## üîê AUTHENTICATION FLOW

```dart
// lib/presentation/screens/auth/login_screen.dart

class LoginScreen extends StatefulWidget {
  @override
  _LoginScreenState createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  final _crewIdController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isLoading = false;
  
  Future<void> _login() async {
    if (!_formKey.currentState!.validate()) return;
    
    setState(() => _isLoading = true);
    
    try {
      // Call login API
      final response = await AuthApi().login(
        crewId: _crewIdController.text,
        password: _passwordController.text,
      );
      
      // Save tokens
      await TokenStorage().saveTokens(
        accessToken: response.accessToken,
        refreshToken: response.refreshToken,
        userId: response.userId,
        crewId: response.crewId,
      );
      
      // Cache user info
      await CacheManager().saveData('user_profile', response.user);
      
      // Navigate to home
      Navigator.pushReplacementNamed(context, '/home');
    } catch (e) {
      // Show error
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('Login failed: ${e.toString()}')),
      );
    } finally {
      setState(() => _isLoading = false);
    }
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Padding(
          padding: EdgeInsets.all(24),
          child: Form(
            key: _formKey,
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                // Logo
                Image.asset('assets/images/logo.png', height: 120),
                SizedBox(height: 48),
                
                // Crew ID field
                TextFormField(
                  controller: _crewIdController,
                  decoration: InputDecoration(
                    labelText: 'Crew ID',
                    prefixIcon: Icon(Icons.person),
                    border: OutlineInputBorder(),
                  ),
                  validator: (value) {
                    if (value?.isEmpty ?? true) {
                      return 'Please enter your Crew ID';
                    }
                    return null;
                  },
                ),
                SizedBox(height: 16),
                
                // Password field
                TextFormField(
                  controller: _passwordController,
                  obscureText: true,
                  decoration: InputDecoration(
                    labelText: 'Password',
                    prefixIcon: Icon(Icons.lock),
                    border: OutlineInputBorder(),
                  ),
                  validator: (value) {
                    if (value?.isEmpty ?? true) {
                      return 'Please enter your password';
                    }
                    return null;
                  },
                ),
                SizedBox(height: 24),
                
                // Login button
                SizedBox(
                  width: double.infinity,
                  height: 48,
                  child: ElevatedButton(
                    onPressed: _isLoading ? null : _login,
                    child: _isLoading
                        ? CircularProgressIndicator(color: Colors.white)
                        : Text('Login'),
                  ),
                ),
                
                // Settings link
                TextButton(
                  onPressed: () {
                    Navigator.pushNamed(context, '/settings/server');
                  },
                  child: Text('Server Settings'),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
```

---

## üìä DATA MODELS

### **Crew Member Model** (`lib/data/models/crew_member.dart`)

```dart
import 'package:json_annotation/json_annotation.dart';

part 'crew_member.g.dart';

@JsonSerializable()
class CrewMember {
  final int id;
  final String crewId;
  final String fullName;
  final String position;
  final String? rank;
  final String? department;
  final String? nationality;
  final String? dateOfBirth;
  final String? phoneNumber;
  final String? email;
  
  // Certificates
  final String? certificateNumber;
  final String? certificateIssue;
  final String? certificateExpiry;
  final String? medicalIssue;
  final String? medicalExpiry;
  final String? passportNumber;
  final String? passportExpiry;
  
  final bool isOnboard;
  final String createdAt;
  
  CrewMember({
    required this.id,
    required this.crewId,
    required this.fullName,
    required this.position,
    this.rank,
    this.department,
    this.nationality,
    this.dateOfBirth,
    this.phoneNumber,
    this.email,
    this.certificateNumber,
    this.certificateIssue,
    this.certificateExpiry,
    this.medicalIssue,
    this.medicalExpiry,
    this.passportNumber,
    this.passportExpiry,
    required this.isOnboard,
    required this.createdAt,
  });
  
  factory CrewMember.fromJson(Map<String, dynamic> json) =>
      _$CrewMemberFromJson(json);
  
  Map<String, dynamic> toJson() => _$CrewMemberToJson(this);
  
  // Certificate status checks
  bool get isCertificateExpiring {
    if (certificateExpiry == null) return false;
    final expiry = DateTime.parse(certificateExpiry!);
    final daysLeft = expiry.difference(DateTime.now()).inDays;
    return daysLeft <= 90 && daysLeft > 0;
  }
  
  bool get isCertificateExpired {
    if (certificateExpiry == null) return false;
    final expiry = DateTime.parse(certificateExpiry!);
    return expiry.isBefore(DateTime.now());
  }
}
```

### **Maintenance Task Model** (`lib/data/models/maintenance_task.dart`)

```dart
import 'package:json_annotation/json_annotation.dart';

part 'maintenance_task.g.dart';

@JsonSerializable()
class MaintenanceTask {
  final int id;
  final String taskId;
  final String equipmentId;
  final String equipmentName;
  final String taskType;
  final String taskDescription;
  final double? intervalHours;
  final int? intervalDays;
  final String? lastDoneAt;
  final String nextDueAt;
  final double? runningHoursAtLastDone;
  final String priority;
  final String status;
  final String? assignedTo;
  final String? completedAt;
  final String? completedBy;
  final String? notes;
  final String? sparePartsUsed;
  final bool isSynced;
  final String createdAt;
  
  MaintenanceTask({
    required this.id,
    required this.taskId,
    required this.equipmentId,
    required this.equipmentName,
    required this.taskType,
    required this.taskDescription,
    this.intervalHours,
    this.intervalDays,
    this.lastDoneAt,
    required this.nextDueAt,
    this.runningHoursAtLastDone,
    required this.priority,
    required this.status,
    this.assignedTo,
    this.completedAt,
    this.completedBy,
    this.notes,
    this.sparePartsUsed,
    required this.isSynced,
    required this.createdAt,
  });
  
  factory MaintenanceTask.fromJson(Map<String, dynamic> json) =>
      _$MaintenanceTaskFromJson(json);
  
  Map<String, dynamic> toJson() => _$MaintenanceTaskToJson(this);
  
  // Computed properties
  int get daysUntilDue {
    final due = DateTime.parse(nextDueAt);
    return due.difference(DateTime.now()).inDays;
  }
  
  bool get isOverdue => daysUntilDue < 0;
  bool get isDueSoon => daysUntilDue >= 0 && daysUntilDue <= 7;
  
  String get priorityColor {
    switch (priority) {
      case 'CRITICAL': return '#DC2626'; // Red
      case 'HIGH': return '#EA580C';    // Orange
      case 'NORMAL': return '#2563EB';  // Blue
      case 'LOW': return '#6B7280';     // Gray
      default: return '#6B7280';
    }
  }
}
```

### **Sync Item Model** (`lib/data/models/sync_item.dart`)

```dart
import 'package:hive/hive.dart';
import 'package:uuid/uuid.dart';

part 'sync_item.g.dart';

@HiveType(typeId: 0)
class SyncItem extends HiveObject {
  @HiveField(0)
  final String id;
  
  @HiveField(1)
  final SyncItemType type;
  
  @HiveField(2)
  final Map<String, dynamic> data;
  
  @HiveField(3)
  final DateTime createdAt;
  
  @HiveField(4)
  int retryCount;
  
  SyncItem({
    String? id,
    required this.type,
    required this.data,
    DateTime? createdAt,
    this.retryCount = 0,
  })  : id = id ?? const Uuid().v4(),
        createdAt = createdAt ?? DateTime.now();
}

@HiveType(typeId: 1)
enum SyncItemType {
  @HiveField(0)
  taskComplete,
  
  @HiveField(1)
  taskStart,
  
  @HiveField(2)
  profileUpdate,
}
```

---

## üîÑ OFFLINE-FIRST STRATEGY

### C∆° Ch·∫ø Ho·∫°t ƒê·ªông

1. **Online Mode** (K·∫øt n·ªëi LAN):
   - G·ªçi API tr·ª±c ti·∫øp
   - Cache response ƒë·ªÉ d√πng offline
   - Hi·ªÉn th·ªã data real-time

2. **Offline Mode** (M·∫•t k·∫øt n·ªëi):
   - ƒê·ªçc data t·ª´ cache
   - User actions ‚Üí Sync queue
   - Hi·ªÉn th·ªã offline indicator

3. **Sync Process** (Khi online tr·ªü l·∫°i):
   - Background service check connectivity
   - Process sync queue t·ª± ƒë·ªông
   - Retry failed items
   - Clear cache sau khi sync th√†nh c√¥ng

### Implementation

```dart
// lib/data/repositories/task_repository.dart

class TaskRepository {
  final TaskApi _api;
  final CacheManager _cache;
  final SyncQueue _syncQueue;
  final NetworkInfo _networkInfo;
  
  TaskRepository(this._api, this._cache, this._syncQueue, this._networkInfo);
  
  // Get my tasks
  Future<List<MaintenanceTask>> getMyTasks() async {
    try {
      if (await _networkInfo.isConnected) {
        // Online: Fetch from API
        final tasks = await _api.getMyTasks();
        
        // Cache for offline use
        await _cache.saveData('my_tasks', tasks);
        
        return tasks;
      } else {
        // Offline: Load from cache
        final cached = await _cache.getData('my_tasks');
        if (cached != null) {
          return (cached as List)
              .map((e) => MaintenanceTask.fromJson(e))
              .toList();
        }
        throw Exception('No cached data available');
      }
    } catch (e) {
      throw Exception('Failed to get tasks: $e');
    }
  }
  
  // Complete task
  Future<void> completeTask({
    required int taskId,
    required String completedBy,
    double? runningHours,
    String? sparePartsUsed,
    String? notes,
  }) async {
    final completeData = {
      'taskId': taskId,
      'completedBy': completedBy,
      'runningHours': runningHours,
      'sparePartsUsed': sparePartsUsed,
      'notes': notes,
      'completedAt': DateTime.now().toIso8601String(),
    };
    
    if (await _networkInfo.isConnected) {
      // Online: Send immediately
      await _api.completeTask(taskId, completeData);
    } else {
      // Offline: Add to sync queue
      await _syncQueue.addToQueue(
        SyncItem(
          type: SyncItemType.taskComplete,
          data: completeData,
        ),
      );
    }
  }
}
```

---

## üöÄ C√ÅC B∆Ø·ªöC TH·ª∞C HI·ªÜN

### Phase 1: Setup & Authentication (Week 1)
1. ‚úÖ T·∫°o Flutter project
2. ‚úÖ Setup dependencies
3. ‚úÖ T·∫°o folder structure
4. ‚úÖ Implement API Client & Interceptor
5. ‚úÖ Implement Token Storage
6. ‚úÖ Build Login Screen
7. ‚úÖ Test authentication v·ªõi Edge Server

### Phase 2: Core Features (Week 2-3)
8. ‚úÖ Implement Data Models
9. ‚úÖ Implement Repositories
10. ‚úÖ Build Home Screen
11. ‚úÖ Build Profile Screen
12. ‚úÖ Build Task List Screen
13. ‚úÖ Build Task Detail Screen
14. ‚úÖ Test CRUD operations

### Phase 3: Offline Support (Week 4)
15. ‚úÖ Implement Cache Manager
16. ‚úÖ Implement Sync Queue
17. ‚úÖ Implement Network Info
18. ‚úÖ Build Complete Task Screen with offline support
19. ‚úÖ Test offline scenarios

### Phase 4: Polish & Testing (Week 5)
20. ‚úÖ Build Schedule Screen
21. ‚úÖ Build Settings Screen
22. ‚úÖ Add loading states & error handling
23. ‚úÖ Add animations & transitions
24. ‚úÖ Integration testing
25. ‚úÖ Bug fixes & optimization

---

## üéØ BACKEND ENDPOINTS C·∫¶N B·ªî SUNG

B·∫°n c·∫ßn th√™m c√°c endpoints sau v√†o **Edge Services**:

### 1. **Authentication API**
```csharp
// POST /api/auth/login
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] LoginRequest request)
{
    // Validate Crew ID + Password
    // Generate JWT token
    // Return: accessToken, refreshToken, user info
}

// POST /api/auth/refresh
[HttpPost("refresh")]
public async Task<IActionResult> RefreshToken([FromBody] string refreshToken)
{
    // Validate refresh token
    // Generate new access token
}
```

### 2. **Crew API - My Profile**
```csharp
// GET /api/crew/me
[HttpGet("me")]
[Authorize]
public async Task<IActionResult> GetMyProfile()
{
    // Get crew info from JWT token
    // Return crew member details
}
```

### 3. **Maintenance API - My Tasks**
```csharp
// GET /api/maintenance/tasks/my-tasks
[HttpGet("tasks/my-tasks")]
[Authorize]
public async Task<IActionResult> GetMyTasks()
{
    // Get crew ID from JWT
    // Return tasks assigned to current crew
    var tasks = await _context.MaintenanceTasks
        .Where(t => t.AssignedTo == currentCrewName)
        .OrderBy(t => t.NextDueAt)
        .ToListAsync();
    
    return Ok(tasks);
}

// POST /api/maintenance/tasks/{id}/start
[HttpPost("tasks/{id}/start")]
[Authorize]
public async Task<IActionResult> StartTask(long id)
{
    // Update status to IN_PROGRESS
    // Log who started
}
```

---

## üì± TESTING SCENARIOS

### 1. Login Test
- ‚úÖ Login with valid credentials
- ‚úÖ Login with invalid credentials
- ‚úÖ Token persistence after app restart
- ‚úÖ Auto-logout on token expiration

### 2. Task Management Test
- ‚úÖ View assigned tasks
- ‚úÖ Filter tasks by status
- ‚úÖ Start task
- ‚úÖ Complete task online
- ‚úÖ Complete task offline ‚Üí Sync when online

### 3. Offline Test
- ‚úÖ Turn off WiFi
- ‚úÖ Navigate app (read cached data)
- ‚úÖ Complete task (add to queue)
- ‚úÖ Turn on WiFi
- ‚úÖ Verify auto-sync

### 4. Certificate Status Test
- ‚úÖ View valid certificates (green)
- ‚úÖ View expiring certificates (yellow)
- ‚úÖ View expired certificates (red)

---

## üîí SECURITY CONSIDERATIONS

1. **Token Storage**: S·ª≠ d·ª•ng `flutter_secure_storage` cho JWT
2. **HTTPS**: Trong production, Edge Server ph·∫£i d√πng HTTPS
3. **Certificate Pinning**: Verify SSL certificate c·ªßa server
4. **Input Validation**: Validate t·∫•t c·∫£ user input
5. **Sensitive Data**: Kh√¥ng log passwords hay tokens
6. **Session Timeout**: Auto-logout sau th·ªùi gian inactive

---

## üìö T√ÄI LI·ªÜU THAM KH·∫¢O

- **Flutter Docs**: https://docs.flutter.dev
- **Dio Package**: https://pub.dev/packages/dio
- **Hive Database**: https://docs.hivedb.dev
- **Provider State Management**: https://pub.dev/packages/provider
- **JWT Handling**: https://pub.dev/packages/jwt_decoder

---

## üéâ K·∫æT LU·∫¨N

V·ªõi ki·∫øn tr√∫c n√†y, mobile app s·∫Ω:
- ‚úÖ **Offline-first**: Ho·∫°t ƒë·ªông m∆∞·ª£t m√† k·ªÉ c·∫£ khi m·∫•t m·∫°ng
- ‚úÖ **LAN Connectivity**: K·∫øt n·ªëi nhanh v·ªõi Edge Server tr√™n t√†u
- ‚úÖ **Cache Smart**: Gi·∫£m bƒÉng th√¥ng, tƒÉng t·ªëc ƒë·ªô
- ‚úÖ **Auto Sync**: ƒê·ªìng b·ªô t·ª± ƒë·ªông khi online
- ‚úÖ **Professional UI**: Giao di·ªán chuy√™n nghi·ªáp cho thuy·ªÅn vi√™n
- ‚úÖ **Secure**: B·∫£o m·∫≠t v·ªõi JWT + Secure Storage
- ‚úÖ **Maritime Focused**: T·∫≠p trung v√†o workflow h√†ng h·∫£i th·ª±c t·∫ø

**B∆∞·ªõc ti·∫øp theo**: T·∫°o Flutter project v√† b·∫Øt ƒë·∫ßu implement t·ª´ Phase 1! üö¢‚öì
